# 🔍 종합 사고 유사도 검색기

모든 특성을 활용한 순수 유사도 검색 시스템입니다. `판정구분`과 `판정사유`를 포함한 모든 정보를 사용하여 유사한 사고 사례를 찾아냅니다.

## 📋 개요

이 시스템은 예측이 아닌 **순수 검색**을 목적으로 합니다. 사용자가 제공한 모든 정보를 기반으로 가장 유사한 사고 사례들을 찾아주며, 각 사례의 판정 과정과 결과를 상세히 보여줍니다.

### 🎯 주요 특징

- **모든 특성 활용**: `판정구분`, `판정사유`를 포함한 모든 특성을 검색 기준으로 사용
- **KoSimCSE 기반 텍스트 유사도**: 한국어 텍스트의 의미적 유사도를 정확히 측정
- **사건별 그룹화**: 같은 사고의 여러 판정을 하나의 사건으로 통합하여 전체 과정 분석
- **판정 과정 시각화**: 각 사례의 판정 과정을 시간순으로 상세히 표시
- **웹 기반 인터페이스**: 직관적인 Streamlit 웹 앱으로 쉬운 사용

## 🏗️ 시스템 구조

```
KoSimCSE/
├── comprehensive_similarity_search.py    # 핵심 검색 엔진
├── run_comprehensive_app.py             # 웹 앱 러너
├── comprehensive_app.py                 # Streamlit 웹 앱 (자동 생성)
├── README_COMPREHENSIVE_SEARCH.md       # 이 문서
└── data/
    └── testy.csv                        # 테스트 데이터
```

## 📊 사용된 특성

### 범주형 특성 (17개)
- `판정진행상태`, `사고진행상태`
- `수출자`, `수입자`, `수입자명`
- `수출보증금액통화`, `결제금액통화`, `사고금액통화`
- `사고유형명`, `수입국`, `보험종목`
- `결제방법`, `결제방법설명`, `결제조건`, `향후결제전망`
- **`판정구분`**, **`판정사유`** ← 핵심 추가 특성

### 수치형 특성 (4개)
- `사고금액`, `결제금액`, `수출보증금액`, `판정금액`

### 텍스트 특성 (3개)
- `사고설명`, `수출자`, `수입자명` (KoSimCSE 임베딩)

## ⚖️ 유사도 계산 방식

### 가중치 분배
- **텍스트 유사도**: 60% (KoSimCSE 기반)
- **범주형 유사도**: 30% (정확한 매칭)
- **수치형 유사도**: 10% (유클리드 거리 기반)

### 계산 방법
1. **텍스트 유사도**: KoSimCSE 임베딩의 코사인 유사도
2. **범주형 유사도**: 매칭되는 범주형 특성의 비율
3. **수치형 유사도**: 유클리드 거리를 유사도로 변환

## 🚀 설치 및 실행

### 1. 필요한 패키지 설치

```bash
pip install streamlit pandas numpy scikit-learn torch transformers plotly
```

### 2. 데이터 준비

`data/testy.csv` 파일을 준비하세요:
- 인코딩: `cp949`
- 필수 컬럼: `보상파일번호`, `사고번호`
- 권장 컬럼: 모든 특성 컬럼들

### 3. 웹 앱 실행

```bash
cd KoSimCSE
python run_comprehensive_app.py
```

또는 직접 실행:

```bash
streamlit run comprehensive_app.py
```

## 💻 사용 방법

### 웹 인터페이스

1. **검색 조건 입력**
   - 드롭다운: 사고유형명, 수입국, 보험종목 등
   - 텍스트 입력: 수출자, 수입자명
   - 수치 입력: 사고금액, 결제금액, 수출보증금액, 판정금액
   - 범주형 선택: 판정진행상태, 판정구분, 판정사유 등

2. **상세 설명 입력**
   - 사고설명 텍스트 영역에 상세한 설명 입력

3. **검색 실행**
   - "🔍 검색" 버튼 클릭

### 프로그래밍 인터페이스

```python
from comprehensive_similarity_search import ComprehensiveSimilaritySearch

# 검색기 초기화
search_engine = ComprehensiveSimilaritySearch()

# 검색 쿼리 구성
query = {
    '사고유형명': '지급거절',
    '수입국': '미국',
    '보험종목': '단기수출보험',
    '판정구분': '면책',  # 판정 결과도 검색 조건으로 사용
    '판정사유': '계약위반',
    '사고설명': '수입자가 지급을 거절함'
}

# 유사 사례 검색
results = search_engine.search_similar_cases(query, top_k=5)

# 결과 출력
for result in results:
    print(f"순위: {result['rank']}, 유사도: {result['similarity']:.3f}")
    print(f"사건 ID: {result['case_id']}")
    print(f"판정 패턴: {result['판정패턴']}")
```

## 📈 검색 결과 해석

### 결과 구조
```python
{
    'rank': 1,                    # 순위
    'similarity': 0.85,           # 유사도 점수 (0~1)
    'case_id': '파일번호_사고번호',  # 사건 식별자
    '판정패턴': '복합 판정: 면책 → 지급',  # 판정 패턴
    '판정요약': '면책(1회), 지급(2회)',   # 판정 요약
    '판정횟수': 3,                # 총 판정 횟수
    'case_info': {                # 사건 기본 정보
        '사고접수일자': '2023-01-01',
        '사고유형명': '지급거절',
        '수입국': '미국',
        # ... 기타 정보
    },
    'decision_process': [         # 판정 과정 상세
        {
            '회차': 1,
            '날짜': '2023-01-15',
            '판정구분': '면책',
            '판정금액': 0,
            '판정사유': '계약위반',
            '진행상태': '완료'
        },
        # ... 추가 판정들
    ]
}
```

### 유사도 점수 해석
- **0.9 이상**: 매우 유사한 사례
- **0.7~0.9**: 높은 유사도
- **0.5~0.7**: 중간 유사도
- **0.5 미만**: 낮은 유사도

## 🔧 고급 기능

### 1. 사건별 그룹화
- 같은 `보상파일번호`와 `사고번호`를 가진 모든 판정을 하나의 사건으로 통합
- 전체 판정 과정을 시간순으로 분석

### 2. 판정 패턴 분석
- 단일 판정 vs 복합 판정 구분
- 판정 변화 패턴 식별 (예: 면책 → 지급)
- 판정 빈도 분석

### 3. KoSimCSE 텍스트 유사도
- 한국어 텍스트의 의미적 유사도 측정
- 배치 처리로 성능 최적화
- GPU 가속 지원

## ⚡ 성능 최적화

### 1. 캐싱
- KoSimCSE 임베딩 캐싱
- Streamlit 앱의 캐시 기능 활용

### 2. 배치 처리
- 텍스트 임베딩 생성 시 배치 처리
- 메모리 효율적인 데이터 처리

### 3. 인덱싱
- 범주형 변수 인코딩
- 수치형 변수 정규화

## 🐛 문제 해결

### 일반적인 문제들

1. **KoSimCSE 모델 로드 실패**
   ```
   ⚠️ KoSimCSE 모델을 찾을 수 없습니다.
   ```
   - 해결: KoSimCSE 폴더가 올바른 위치에 있는지 확인
   - 대안: 텍스트 유사도만 사용하여 검색 진행

2. **데이터 파일 오류**
   ```
   ❌ 데이터 파일을 찾을 수 없습니다
   ```
   - 해결: `data/testy.csv` 파일이 올바른 위치에 있는지 확인
   - 인코딩이 `cp949`인지 확인

3. **메모리 부족**
   ```
   CUDA out of memory
   ```
   - 해결: 배치 크기 줄이기 (`batch_size` 파라미터 조정)
   - CPU 모드 사용

### 디버깅 팁

1. **검색 결과가 없는 경우**
   - 검색 조건이 너무 구체적인지 확인
   - 일부 조건을 제거하고 다시 시도

2. **유사도가 낮은 경우**
   - 텍스트 설명을 더 상세히 입력
   - 범주형 조건을 조정

3. **성능이 느린 경우**
   - GPU 사용 가능 여부 확인
   - 배치 크기 조정

## 🔄 기존 시스템과의 차이점

| 구분 | 기존 시스템 | 종합 검색기 |
|------|-------------|-------------|
| 목적 | 예측 기반 검색 | 순수 유사도 검색 |
| 판정구분/판정사유 | 예측 결과로 표시 | 검색 조건으로 사용 |
| 특성 수 | 제한적 (7개 범주형) | 포괄적 (17개 범주형) |
| 수치형 특성 | 2개 | 4개 |
| 텍스트 처리 | 기본 유사도 | KoSimCSE 임베딩 |

## 📝 라이선스

이 프로젝트는 교육 및 연구 목적으로 개발되었습니다.

## 🤝 기여

버그 리포트나 기능 제안은 이슈로 등록해주세요.

---

**🔍 종합 사고 유사도 검색기 | 모든 특성을 활용한 순수 검색 시스템** 